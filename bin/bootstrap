#! /usr/bin/env bash

### QUICKSETUP
# RUN THIS (don't use curl because it's not always installed):
# u="https://raw.githubusercontent.com/nsheaps/n8-ansible/main/bin/bootstrap"; t="$(mktemp)"; wget -O - "$u" > "$t" && chmod +x "$t" && "$t"; rm "$t" || echo "not found"

# exit if something fails
set -e

# no unset vars
set -u

# fail on pipes too
set -o pipefail

# print commands before running them
# set -x
# try to sudo to make sure we have sudo access
sudo echo "sudo access granted"

# prefer apt for installing packages, but use brew if it's available
if [ -x "$(command -v apt-get)" ]; then
  sudo apt-get install -y curl
  # if gum is not installed, install it
  # gum: https://github.com/charmbracelet/gum
  if [ -x "$(command -v gum)" ]; then
    gum spin --spinner minidot --title "Updating apt sources" --show-output -- sudo apt-get update
  else
    # Debian/Ubuntu
    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
    echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
    sudo apt-get update && sudo apt-get install -y gum
  fi
  command -v git || gum spin --spinner minidot --title "Installing git using apt" --show-output -- sudo apt-get install -y git
  command -v gh || gum spin --spinner minidot --title "Installing gh using apt" --show-output -- sudo apt-get install -y gh
  command -v lastpass-cli || gum spin --spinner minidot --title "Installing lastpass-cli using apt" --show-output -- sudo apt-get install -y lastpass-cli
  command -v curl || gum spin --spinner minidot --title "Installing curl using apt" --show-output -- sudo apt-get install -y curl
  command -v ansible || gum spin --spinner minidot --title "Installing ansible using apt" --show-output -- sudo apt-get install -y ansible
  command -v gum || gum spin --spinner minidot --title "Installing gum using apt" --show-output -- sudo apt-get install -y gum
elif [ -x "$(command -v brew)" ]; then
  brew install gum

  command -v git || gum spin --spinner minidot --title "Installing git using brew" --show-output -- brew install git
  command -v gh || gum spin --spinner minidot --title "Installing gh using brew" --show-output -- brew install gh
  command -v lastpass-cli || gum spin --spinner minidot --title "Installing lastpass-cli using brew" --show-output -- brew install lastpass-cli
  command -v curl || gum spin --spinner minidot --title "Installing curl using brew" --show-output -- brew install curl
  command -v ansible || gum spin --spinner minidot --title "Installing ansible using brew" --show-output -- brew install ansible
else
  echo "PANIC: unsupported system type, apt and brew are not installed"
  exit 1
fi

# LPASS_ACCOUNT_EMAIL but defaults to first arg
LPASS_ACCOUNT_EMAIL="${1:-}"
# if LPASS_ACCOUNT_EMAIL is unset
if [ -z "$LPASS_ACCOUNT_EMAIL" ]; then
  # if the user has a lastpass account, ask for their email
  if ! lpass status > /dev/null; then
    # ask for their email
    gum style --border-foreground "#FF0" --border thick --padding "0 0" "Enter your lastpass account email to login to lpass"
    LPASS_ACCOUNT_EMAIL="$(gum input --placeholder "example@example.com")"
  fi
fi

# login to lastpass
if ! lpass status > /dev/null; then
  gum style --border-foreground "#FF0" --border thick --padding "0 0" "Logging in to lastpass (user: $LPASS_ACCOUNT_EMAIL)"
  lpass login --trust "$LPASS_ACCOUNT_EMAIL"
fi

REPO="${2:-}"
# if REPO is unset
if [ -z "$REPO" ]; then
  gum style --border-foreground "#FF0" --border thick --padding "0 0" "Upstream config repo:"
  REPO="$(gum input --value "https://github.com/nsheaps/n8-ansible.git")"
fi

# install openssh-server
if [ -x "$(command -v apt-get)" ]; then
  gum spin --spinner minidot --title "Installing openssh-server using apt" --show-output -- sudo apt-get install -y openssh-server
# else if this is a mac system (aka darwin)
elif [ "$(uname -s)" == "Darwin" ]; then
  # gum spin --spinner minidot --title "Enabling SSH " --show-output -- brew install openssh-server
  echo "PANIC: unsupported system type, need to add ssh install instructions for macos"
  # note for future: https://superuser.com/questions/104929/how-do-you-run-a-ssh-server-on-mac-os-x
else
  echo "PANIC: unsupported system type, need to add ssh install instructions for other OSs"
fi


# login to gh
# gh auth login --with-token <<< "$(lpass show --notes "github.com/$GH_AUTH_USER")"
gh auth login # login interactively

# if the upstream of this repo is $REPO, cd to the root of the repo, otherwise, check it out
if [ "$(git config --get remote.origin.url)" == "$REPO" ]; then
  cd "$(git rev-parse --show-toplevel)"
  ROOT_DIR="$(pwd)"
  export ROOT_DIR
elif gum confirm "Checkout n8-ansible to random temp dir?"; then
  # make a tempdir to do all of our work
  TEMP_DIR="$(mktemp -d)"
  cd "$TEMP_DIR"

  # clone the repo
  git clone "$REPO"
  cd n8-ansible
  ROOT_DIR="$(pwd)"
  export ROOT_DIR
# ask if the user would like to check out the repo to ~/src/n8-ansible, $(mktemp -d), other, or exit
else
  gum style --border-foreground "#FF0" --border thick --padding "0 4"  "Enter a directory to check out n8-ansible to, or ctrl-c to exit"
  REPO_NAME="$(echo "$REPO" | cut -d '/' -f5 | cut -d '.' -f1)"
  INPUT="$(gum input --value "$HOME/src/n8-ansible")"
  # remove any trailing slashes from the input
  INPUT="$(echo "$INPUT" | sed 's/\/$//g')"
  # get last folder name from input
  REPO_NAME="$(basename "$INPUT")"
  LIVES_IN="$(dirname "$INPUT")"

  mkdir -p "$LIVES_IN"
  cd "$LIVES_IN"
  git clone "$REPO" "$REPO_NAME"
  cd "$REPO_NAME"
  ROOT_DIR="$(pwd)"
  export ROOT_DIR
fi


lpass show "Home/ansible node bootstrap config" --note > "$HOME/.bootstraprc"
. "$HOME/.bootstraprc"

# run ansible
ansible-playbook ./playbooks/bootstrap.yml --ask-become-pass --extra-vars "{\"running_as\":\"$USER\", \"root_dir\":\"$ROOT_DIR\"}"

gum style --border-foreground "#0F0" --border thick --padding "2 4"  "Bootstrap complete!"
